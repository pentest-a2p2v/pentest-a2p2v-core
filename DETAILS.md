# DETAILS

To get started, first read the [README](README.md).

This document describes additional configuration details.

## Configuration

Many configurable items can be specified on the command line.

Type 'a2p2v -h' to see available options:

```
usage: a2p2v [-h] [-v] [-nx NETFILE] [-f DATAFILE] [-t TARGET | -p] [-x] [-s] [-lh LHOST] [-lt LOADTREES] [-sw SWITCHVISITS]
               [-mh MAXHOPS] [-tn TREENUM] [-ms MINSCORE] [-r] [--postexecutescript POST_EXECUTE_SCRIPT] [-g] [--cpdb DBFILE]

A2P2V Version 1.1.0

optional arguments:
  -h, --help            show this help message and exit
  -v, --verbose         Use to display more detailed logging
  -nx NETFILE, --netfile NETFILE
                        Network Description File (Required for System Mode Planning)
  -f DATAFILE, --datafile DATAFILE
                        Scan data file to use (Nessus, NMAP, Common)
  -t TARGET, --target TARGET
                        Choose a target to run in single host mode. If omitted all hosts are used
  -p, --plan            Run in system planning mode to generate attack trees based on intial conditions and goal
  -s, --showgraph       Display visualizations (Network Representation, Combined Attack Tree, Execution Progress
  -lh LHOST, --lhost LHOST
                        Manually Set LHOST in Metasploit (IP address of attacker) if not correctly detected
  -lt LOADTREES, --loadtrees LOADTREES
                        Specify a json file with precomputed attack trees to load (skips analysis and planning)
  -sw SWITCHVISITS, --switchvisits SWITCHVISITS
                        Set how many times each switch can be visited in an attack tree
  -mh MAXHOPS, --maxhops MAXHOPS
                        Set the maximum number of hops allowed per attack tree
  -tn TREENUM, --treenum TREENUM
                        Specify attack tree number to execute if already known
  -ms MINSCORE, --minscore MINSCORE
                        Specify a minimum score for attack trees to display during selection
  -r, --reload          Reload the Metasploit cache
  --postexecutescript POST_EXECUTE_SCRIPT
                        Optional: script to execute after each execution
  --cpdb YAMLFILE
                        Copy a YAML formatted capabilitgies file to the config dir
```

### Configuration file


The configuration file is located at:

```
$HOME/.config/a2p2v/a2p2v.conf
```

The sections of the configuration file are:

    [INPUT]

    # Default settings are provided here for "default_datafile" and "default_netfile".
    # These can be overridden by using the command line arguments "--datafile" and
    # "--netfile" commands respectively.

    [PLANNING]

    # Default scoring weights are provided here as 'score_weights' which are
    # applied to each of the attack tree scoring components.

    [INITIAL_CONDITIONS]

    # Default initial conditions are provided here. These can be uncommented and
    # will work with the provided data files in the lab_config directory.

    #[GOALS]

    # A default goal condition is provided here. It can be uncommented and
    # will work with the provided data files in the lab_config directory.
    # See the section below for defining new goals.

    [SENSITIVE]

    # Defined identically to goal states but are simply noted in attack trees / reporting
    # when sensitive states are reached.  Sensitive states are an experimental feature and
    # not all goal states are currently supported as sensitive states
    # (only current_host and current_status).

    [METASPLOIT]

    # Default Metasploit RPC connection configuration values are provided here.

## Defining GOALS

In general a goal can be defined in a2p2v.conf with several criteria:

    <goal_name> = {"type":"<type>", "key":"<key>", "value":"<value>", "host":"<host>"}

The fields are used as the following:

- *type*: Currently the only option is *state*
- *key*: Options are *current_status*, *current_host*, *current_role*, *current_access* or *target_host*
- *value*: Depending on the value of *key*, the *value* is used accordingly:
- *host*: For all but "current_host" or "target_host" (which this does not apply to) this optionally specifies a specific host for the goal to apply to.

key            | meaning                                                      | example value
---------------|--------------------------------------------------------------|----------
current_status | status to match                                              | change_temp
current_host   | name of host to which access is to be obtained               | OPC
target_host    | name of host to which network reachability is to be obtained | OPC
current_access | name of access level {none, web, shell, desktop, metasploit} | shell
current_role   | user role {none, user, or admin}                             | admin


A *current_role* goal is achieved when a specific role has been gained on any, or a specific host and could be specified, for example, as:  

    Admin_Access_Any = {"type":"state", "key":"current_role", "value":"admin"}

A *current_access* goal is achieved when a specific level of access has been gained on any, or a specific host and could be specified, for example, as:  

    Shell_Access_Any = {"type":"state", "key":"current_access", "value":"shell"}

A *current_host goal* is achieved when any type of access has been gained on a host and could be specified, for example, as:

    USER1_Access = {"type":"state", "key":"current_host", "value":"USER1"}

A *current_status* goal is achieved when a specific status is obtained in an attack tree which may be set by a capability or be the name of a capability itself, for example:

    Change_Temperature = {"type":"state", "key":"target_status", "value":"change_temp"}

A *target_host* goal is achieved when network reachability is gained to a specific host, for example:

    USER1_Reachable = {"type":"state", "key":"target_host", "value":"USER1"}

### Metasploit Module Options #

Metasploit modules are often implemented with different options and a configuration file is used to specify values for the options.

The Metasploit configuration file resides in the configuration directory (~/.config/a2p2v)

- metasploit_conf.json

The file is in JSON format and can be modified

For example, the entry for **exploit/multi/http/wp_ninja_forms_unauthenticated_file_upload**is:

```json
    "exploit/multi/http/wp_ninja_forms_unauthenticated_file_upload": {
        "type": "exploit",
        "name": "WordPress Ninja Forms Unauthenticated File Upload",
        "fullname": "exploit/multi/http/wp_ninja_forms_unauthenticated_file_upload",
        "rank": "excellent",
        "description": "Versions 2.9.36 to 2.9.42 of the Ninja Forms plugin contain an unauthenticated file upload vulnerability, allowing guests to upload arbitrary PHP code that can be executed in the context of the web server.",
        "arch": [
            "php"
        ],
        "targets": {
            "0": "ninja-forms"
        },
        "cves": [
            "2016-1209"
        ],
        "options": {
            "RHOSTS": "",
            "RPORT": 80,
            "HttpUsername": "sploit",
            "HttpPassword": "sploit",
            "TARGETURI": "/wordpress/",
            "FORM_PATH": "/index.php/king-of-hearts/"
        }
    },
```

The options can be modified according to the setup of the target environment

### Capabilities definitions #

A default capabilities definition files are located in `lab_config/capabilities_user.yml` and `lab_config/capabilities_metasploit.yml`. They contain the definitions of pre-conditions, actions and post-conditions in regards to capabilities (or exploits).

For the most part, these file can be used as is, with no changes required.

Some capability definitions include specific details in `lab_config/capabilities_user.yml`, that can be modified to suit operational needs.

For example, the "change temperature" capability is set to change the temperature to 30 Celsius.

This can be modified by changing the `data_registers` parameter in the line:

```yaml
modbus.write_register.change_temp:
  actions:
  - key: parameters
    type: capability
    value:
      data_address: '2'
      data_registers: '30'
      unit_number: '255'
  capability_class: service
  capability_id: modbus.write_register.change_temp
  cves: ''
  cvss: ''
  postconditions: []
  preconditions:
  - host: $target_host
    key: capability_id
    type: capability
    value: modbus.write_register
  rank: normal
  severity: high
  solution: Restrict access to this sensitive, insecure service.
  subclass: modbus.write_register.change_temp
  title: modbus.write_register.change_temp
```

Note that the capability id contains dot-separated fields. This means that the capability inherits from other capabilities.

In this instance `modbus.write_register.change_temp` inherits alll the pre-conditions and actions from `modbus.write_register`:

```yaml
modbus.write_register:
  actions:
  - key: parameters
    type: capability
    value:
      action: WRITE_REGISTERS
  capability_class: service
  capability_id: modbus.write_register
  cves: ''
  cvss: ''
  postconditions: []
  preconditions:
  - host: $target_host
    key: capability_id
    type: capability
    value: modbus
  rank: normal
  severity: high
  solution: Restrict access to this sensitive, insecure service.
  subclass: modbus.write_register
  title: modbus.write_register
```

In turn, "modbus.write_register" inherits alll the pre-conditions and actions from "modbus":

```yaml
modbus:
  actions:
  - key: parameters
    type: metasploit
    value:
      action: $action
      data_address: $data_address
      data_registers: $data_registers
      module: auxiliary/scanner/scada/modbusclient
      rhost: $target_host
      unit_number: $unit_number
  capability_class: service
  capability_id: modbus
  cves: ''
  cvss: ''
  postconditions: []
  preconditions:
  - host: $current_host
    key: current_access
    type: state
    value: shell
  - host: $target_host
    key: port
    type: service
    value: tcp/502
  rank: normal
  severity: high
  solution: Restrict access to this sensitive, insecure service.
  subclass: modbus
  title: modbus
```

On first run, or when the `lab_config/capabilities_user.yml` file is changed, it needs to be reloaded into the database. This can be done by using the `--cpdb` command line argument. For example:

```
$ a2p2v --cpdb lab_config/capabilities_user.yml
```

## Network topology definition

The network topology of the target network can be specified in the network topology definition file.  A sample topology has been provided for the lab network in the file `lab_config/networkGraph.xml`.

## Input formats 

Three data input formats are support: common format, Nmap results and Nessus results.  The name of the data file is specified by the command line argument `--datafile` or `-f` and the type of format is automatically detected.

### Common/Common2 data file

The custom common input format describes hosts and vulnerabilities/services associated with those hosts in an easy to edit CSV format.  The common format can be used to quickly create a list of attacks to attempt when other scanning tools are unavailable.  It is also the format into which any other (Nessus or Nmap) format is converted to when run.  A header line provides easily understood identifiers for each column.

### Nmap

Nmap is a free open-source networking tool that can be used to enumerate hosts, discover open ports and identify vulnerabilities. The output of an Nmap scan when using the command line flags `-oX` and `--script vuln` can be directly loaded.  The tool will additionally convert the Nmap formatted scan to common, and output it to the same directory with nmap_converted.common appended to the filename.

For example, the following scans the `192.168.30.0/24` subnet:

    nmap -A -p 1-65535 192.168.30.0/24 -oX simple.nmap --script vuln 

The results file "simple.nmap" can be read:

```xml
<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE nmaprun>
<hostscript><script id="samba-vuln-cve-2012-1182" output="NT_STATUS_ACCESS_DENIED">false</script>
...
<table key="CVE-2017-0143">
<elem key="title">Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)</elem>
<elem key="state">VULNERABLE</elem>
...
</nmaprun>
```

### Nessus data file

Nessus is a commercial vulnerability scanning tool.  Similar to Nmap, it can be used to enumerate hosts, discover open ports and identify vulnerabilities.  However, Nessus has a much larger number of vulnerability detection plugins compared to Nmap and is heavily used by professional penetration testers.

The Nessus data file (`.nessus`) is the file that can be exported from the Nessus vulnerability scanner, which can be directly used by the tool.

To export scan results from Nessus: (based on your version of Nessus, the exact steps may vary.)

1.    In the top navigation bar, click "Scans"
2.    Click on a scan and the scan results page will be shown.
3.    In the upper-right cornet, click Export.
4.    From the drop-down box, select the "Nessus" format.

As with the Nmap, the tool will additionally convert the Nessus formatted scan to `common2` and `common`, and output them to the same directory with `_nessus_converted.common2` and `_nessus_converted.common` appended to the filename.
