#!/usr/bin/env python3
# SPDX-License-Identifier: Apache-2.0
# See README.md for license details


import pytest

from a2p2v.metasploitdb import MetasploitDB


broken_modules = [
    "exploit/windows/smb/ms17_010_eternalblue_win8",
    "exploit/linux/misc/saltstack_salt_unauth_rce",
]

cves = {
    "CVE-2016-1209": [
        "exploit/multi/http/wp_ninja_forms_unauthenticated_file_upload"
    ],
    "CVE-2019-0708": ["exploit/windows/rdp/cve_2019_0708_bluekeep_rce"],
    "CVE-2017-0143": [
        "exploit/windows/smb/ms17_010_eternalblue",
        "exploit/windows/smb/ms17_010_psexec",
    ],
    "CVE-2017-0147": [
        "exploit/windows/smb/ms17_010_eternalblue",
        "exploit/windows/smb/ms17_010_psexec",
    ],
}

data = {
    "exploit/multi/http/wp_ninja_forms_unauthenticated_file_upload": {
        "options": {
            "TARGETURI": "/wordpress/",
            "FORM_PATH": "/index.php/king-of-hearts/",
        },
    },
    "exploit/windows/smb/ms17_010_eternalblue": {
        "name": "MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption",
        "cves": [
            "2017-0143",
            "2017-0144",
            "2017-0145",
            "2017-0146",
            "2017-0147",
            "2017-0148",
        ],
        "options": {"RHOSTS": "", "RPORT": 445},
    },
    "exploit/windows/smb/ms17_010_psexec": {
        "type": "exploit",
        "name": "MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution",
        "rank": "normal",
        "description": "This module will exploit SMB with vulnerabilities in MS17-010...",
        "arch": ["x86", "x64"],
        "cves": ["2017-0143", "2017-0146", "2017-0147"],
        "options": {"RHOSTS": "", "RPORT": 445},
    },
}

modules = {
    "exploit/multi/http/wp_ninja_forms_unauthenticated_file_upload": "WordPress Ninja Forms Unauthenticated File Upload",
    "exploit/multi/misc/weblogic_deserialize_asyncresponseservice": "Oracle Weblogic Server Deserialization RCE - AsyncResponseService",
    "exploit/windows/iis/iis_webdav_scstoragepathfromurl": "Microsoft IIS WebDav ScStoragePathFromUrl Overflow",
    "exploit/windows/smb/ms17_010_eternalblue": "MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption",
    "exploit/windows/smb/ms17_010_psexec": "MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution",
}

names = {value: key for key, value in modules.items()}

name_to_cvelist = {
    "MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption": [
        "CVE-2017-0143",
        "CVE-2017-0144",
        "CVE-2017-0145",
        "CVE-2017-0146",
        "CVE-2017-0147",
        "CVE-2017-0148",
    ],
    "MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution": [
        "CVE-2017-0143",
        "CVE-2017-0146",
        "CVE-2017-0147",
    ],
}


@pytest.fixture(autouse=True, scope='function')
def load_sample_data():
    """Load the MetasploitDB with sample data, so it does not have to
    try to reach out to the Metasploit API nor read the cached
    Metasploit config file.
    """
    MetasploitDB.data = data
    MetasploitDB.broken_modules = broken_modules
    MetasploitDB.cves = cves
    MetasploitDB.modules = modules
    MetasploitDB.names = names
    MetasploitDB.name_to_cvelist = name_to_cvelist
